<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sunwin AI Tool</title>

<style>
html,body{
    margin:0;
    width:100%;
    height:100%;
    overflow:hidden;
    background:#000;
    font-family:Arial
}

#sunwin{
    position:fixed;
    inset:0;
    width:100vw;
    height:100vh;
    border:none;
    z-index:1;
}

/* TOOL */
#tool{
    position:fixed;
    top:80px;
    left:12px;
    width:120px;
    background:rgba(0,0,0,.78);
    border-radius:10px;
    padding:6px;
    color:#fff;
    z-index:9999;
    user-select:none;
}

#tool img{
    width:34px;
    display:block;
    margin:0 auto 4px;
    filter:drop-shadow(0 0 5px gold);
}

#phien{
    font-size:10px;
    text-align:center;
    margin-bottom:4px;
}

#du-doan{
    font-size:12px;
    text-align:center;
    font-weight:bold;
    padding:4px 0;
    border-radius:6px;
    background:#222;
}

.tai{color:#4caf50}
.xiu{color:#ff5252}
.err{color:#ff9800}
</style>
</head>

<body>

<iframe id="sunwin" src="https://web.sunwin.sx/"></iframe>

<div id="tool">
    <img src="sunwin.png">
    <div id="phien">Phiên: --</div>
    <div id="du-doan" class="err">Đang tải…</div>
</div>

<script>
const API="https://sunwinsaygex-pcl2.onrender.com/api/sun";
let lastData=null;

/* FETCH CÓ TIMEOUT */
function fetchWithTimeout(url,ms=3000){
    return Promise.race([
        fetch(url),
        new Promise((_,rej)=>setTimeout(()=>rej("timeout"),ms))
    ]);
}

/* AI KHÔNG CẦN LỊCH SỬ */
function ai(d){
    let votes=[];
    const tong=d.tong;
    if(tong<=7) votes.push("Xỉu");
    if(tong>=14) votes.push("Tài");
    if(tong>=9 && tong<=10) votes.push("Tài");
    if(tong>=11 && tong<=12) votes.push("Xỉu");
    if(d.du_doan) votes.push(d.du_doan);

    let t=votes.filter(v=>v==="Tài").length;
    let x=votes.length-t;
    return t>=x?"Tài":"Xỉu";
}

async function run(){
    try{
        const r=await fetchWithTimeout(API);
        let d=await r.json();

        // nếu API trả mảng
        if(Array.isArray(d)) d=d[0];
        lastData=d;

    }catch(e){
        if(!lastData){
            duDoan.innerText="API chậm";
            duDoan.className="err";
            return;
        }
    }

    const d=lastData;
    phien.innerText="Phiên: "+d.phien_hien_tai;

    const kq=ai(d);
    duDoan.innerText="AI: "+kq;
    duDoan.className=kq==="Tài"?"tai":"xiu";
}

run();
setInterval(run,4000);

/* DRAG (KHÔNG PHỤ THUỘC API) */
let drag=false,ox,oy;
tool.addEventListener("mousedown",e=>{
    drag=true;
    ox=e.clientX-tool.offsetLeft;
    oy=e.clientY-tool.offsetTop;
});
document.addEventListener("mousemove",e=>{
    if(drag){
        tool.style.left=e.clientX-ox+"px";
        tool.style.top=e.clientY-oy+"px";
    }
});
document.addEventListener("mouseup",()=>drag=false);

tool.addEventListener("touchstart",e=>{
    drag=true;
    ox=e.touches[0].clientX-tool.offsetLeft;
    oy=e.touches[0].clientY-tool.offsetTop;
});
document.addEventListener("touchmove",e=>{
    if(drag){
        tool.style.left=e.touches[0].clientX-ox+"px";
        tool.style.top=e.touches[0].clientY-oy+"px";
    }
});
document.addEventListener("touchend",()=>drag=false);
</script>

</body>
</html>
